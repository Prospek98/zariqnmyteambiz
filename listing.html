<!doctype html>
<script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbxmz1In-BjFP0dGspnYVRRbqJzuTmpxYfKflq4LLzQKU9dGxvtOgTROcxQ9p80oTVA/exec';
const id = new URLSearchParams(location.search).get('id');


function monthly(price, dp=0.1, rate=0.035, years=7){
const P = Number(price)*(1-dp); const r=rate/12; const n=years*12; return (P*r)/(1-Math.pow(1+r,-n));
}


async function load(){
const r=await fetch(`${WEB_APP_URL}?path=listing&id=${encodeURIComponent(id)}`); const j=await r.json(); if(!j.ok||!j.data) throw new Error('Not found'); const x=j.data;
const imgs=(x.image_urls||'').split(',');
const wa = `https://wa.me/${x.seller_phone}?text=${encodeURIComponent('Hai, saya berminat: '+x.title+' (ID '+x.id+')')}`;
document.getElementById('wrap').innerHTML = `
<div class="bg-white rounded-2xl overflow-hidden shadow">
<div class="grid md:grid-cols-2">
<div class="bg-gray-100 aspect-[16/12]">
<img src="${imgs[0]||''}" class="w-full h-full object-cover"/>
</div>
<div class="p-5">
<h1 class="text-2xl font-semibold">${x.title}</h1>
<div class="text-indigo-700 text-xl font-bold mt-1">RM ${(Number(x.price)||0).toLocaleString('ms-MY')}</div>
<div class="text-sm text-gray-600 mt-1">${x.year||'-'} • ${x.brand||'-'} ${x.model||''} • ${x.transmission||'-'} • ${x.location||'-'}</div>
<div class="mt-3 p-3 bg-indigo-50 rounded-xl text-sm">Anggaran ansuran bulanan: <b>RM ${(monthly(x.price)||0).toFixed(2)}</b> (DP 10%, 3.5%, 7 tahun)</div>
<div class="flex gap-3 mt-4">
<a class="px-4 py-2 rounded-xl bg-green-600 text-white" href="${wa}" target="_blank">WhatsApp Penjual</a>
<button id="btnBook" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Tempah Test Drive</button>
</div>
</div>
</div>
</div>


<div id="gallery" class="grid grid-cols-3 gap-3 mt-4"></div>


<dialog id="dlg" class="rounded-xl p-0 w-11/12 md:w-[520px]">
<form id="fBook" class="p-5">
<h3 class="text-lg font-semibold mb-3">Tempah Test Drive</h3>
<input class="border w-full rounded-xl px-3 py-2 mb-2" placeholder="Nama" id="b_name"/>
<input class="border w-full rounded-xl px-3 py-2 mb-2" placeholder="Telefon" id="b_phone"/>
<input type="datetime-local" class="border w-full rounded-xl px-3 py-2 mb-3" id="b_dt"/>
<div class="flex justify-end gap-2">
<button type="button" id="b_cancel" class="px-3 py-2">Batal</button>
<button class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Hantar</button>
</div>
</form>
</dialog>
`;
document.getElementById('gallery').innerHTML = imgs.slice(0,6).map(u=>`<img class='rounded-xl w-full h-36 object-cover' src='${u}'/>`).join('');
const dlg=document.getElementById('dlg');
document.getElementById('btnBook').onclick=()=>dlg.showModal();
document.getElementById('b_cancel').onclick=()=>dlg.close();
document.getElementById('fBook').onsubmit=async(e)=>{
e.preventDefault();
const payload={ type:'testdrive', listing_id:id, name: b_name.value, phone: b_phone.value, date_time: b_dt.value };
const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'add_booking',payload})});
const j=await r.json(); if(j.ok){ alert('Tempahan diterima. Kami akan hubungi anda.'); dlg.close(); } else alert('Ralat: '+j.error);
}
}


load().catch(e=>{ document.getElementById('wrap').innerHTML=`<div class='text-red-600'>${e.message}</div>` })
</script>
</body>
</html>
