<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Portal Ejen • CarHub Johor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <script src="./config.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header class="container row" style="justify-content:space-between">
    <div class="logo"><span class="logo-dot"></span>Portal Ejen</div>
    <div id="authBox" class="row"></div>
  </header>

  <main class="container card">
    <div class="card-pad">
      <div class="kicker">Buat Booking</div>
      <h2 class="h2">Servis / Test Drive</h2>
      <div class="grid grid-2">
        <input id="sale_id" class="input" placeholder="Sale ID (jika ada portal pelanggan)">
        <input id="cust_phone" class="input" placeholder="Telefon pelanggan">
        <select id="type" class="select"><option value="service">Servis</option><option value="testdrive">Test Drive</option></select>
        <input id="brand" class="input" placeholder="Jenama">
        <input id="model" class="input" placeholder="Model">
        <input id="mileage" class="input" placeholder="Mileage (km)">
        <label class="row"><input id="pickup" type="checkbox"> Perlu pick-up</label>
        <label class="row"><input id="use_rebate" type="checkbox"> Guna rebate (jika ada)</label>
        <input id="notes" class="input" placeholder="Nota">
      </div>
      <div class="sep"></div>
      <button class="btn" onclick="createBooking()">Hantar</button>
      <div id="result" class="notice" style="margin-top:8px"></div>
    </div>
  </main>

  <footer class="container footer">© <span id="year"></span> CarHub Johor</footer>

  <script>
    document.getElementById('year').textContent=new Date().getFullYear();

    // Google Sign-In
    window.onload = () => {
      const box = document.getElementById('authBox');
      if(localStorage.getItem('id_token')){
        box.innerHTML = `<span class="badge">Logged in</span><button class="btn btn-ghost" onclick="signOut()">Sign out</button>`;
      } else {
        box.innerHTML = `<div id="g_id_onload" data-client_id="${CLIENT_ID}" data-auto_prompt="false" data-callback="onSignIn"></div>
        <div class="g_id_signin" data-type="standard" data-size="large"></div>`;
        google.accounts.id.initialize({ client_id: CLIENT_ID, callback:onSignIn });
        google.accounts.id.renderButton(document.querySelector('.g_id_signin'), { theme:'outline', size:'large' });
      }
    };
    function onSignIn(res){ if(res && res.credential){ localStorage.setItem('id_token', res.credential); location.reload(); } }
    function signOut(){ localStorage.removeItem('id_token'); location.reload(); }

    async function createBooking(){
      const payload={
        sale_id: sale_id.value, customer_phone: cust_phone.value, type: type.value,
        brand: brand.value, model: model.value, mileage: mileage.value,
        pickup: pickup.checked, use_rebate: use_rebate.checked, notes: notes.value
      };
      const r=await apiPost('create_booking', payload, true);
      result.textContent = r.ok ? `Booking ID: ${r.data.booking_id} • Jumlah: ${fmtRM(r.data.amount_due)}` : (r.error||'Gagal');
    }
  </script>
</body>
</html>
