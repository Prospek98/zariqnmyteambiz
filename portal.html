<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Portal Pelanggan • CarHub Johor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <script src="./config.js"></script>
</head>
<body>
  <header class="container">
    <div class="logo"><span class="logo-dot"></span>Portal Pelanggan</div>
  </header>

  <main class="container grid grid-2">
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Akaun</div>
        <h2 class="h2" id="custName">Memuat...</h2>
        <div class="row">
          <div class="badge">Sale ID: <span id="saleId" class="mono"></span></div>
          <div class="badge">Baki Rebate: <span id="bal"></span></div>
          <div class="badge">Had per transaksi: <span id="cap"></span></div>
        </div>
        <div class="sep"></div>
        <div id="expiryBox" class="row"></div>
      </div>
    </section>

    <section class="card">
      <div class="card-pad">
        <div class="kicker">Booking Servis / Test Drive</div>
        <h2 class="h2">Buat Janji Temu</h2>
        <div class="grid grid-2">
          <select id="bk_type" class="select"><option value="service">Servis</option><option value="testdrive">Test Drive</option></select>
          <input id="bk_brand" class="input" placeholder="Jenama (cth Proton)">
          <input id="bk_model" class="input" placeholder="Model (cth X70)">
          <input id="bk_mileage" class="input" placeholder="Mileage km (cth 10,000)">
          <label class="row"><input id="bk_pickup" type="checkbox"> Perlukan pick-up (RM100)</label>
          <label class="row"><input id="bk_use_rebate" type="checkbox"> Guna rebate automatik</label>
          <input id="bk_notes" class="input" placeholder="Nota">
          <button class="btn" onclick="createBooking()">Hantar Booking</button>
        </div>
        <div id="bkResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="card-pad">
        <div class="kicker">Sejarah Rebate</div>
        <div id="ledger"></div>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="card-pad">
        <div class="kicker">Kereta Baharu</div>
        <div id="upsell" class="grid grid-3"></div>
      </div>
    </section>
  </main>

  <footer class="container footer">© <span id="year"></span> CarHub Johor</footer>

  <script>
    document.getElementById('year').textContent=new Date().getFullYear();
    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    function fmt(n){ return "RM " + Number(n||0).toLocaleString("ms-MY"); }
    function countdown(exp){ return Math.max(0, Math.ceil((new Date(exp)-new Date())/(1000*3600*24))); }
    function line(o){
      const sign = (o.type==='redeem'?'-':'+');
      return `<div class="row" style="justify-content:space-between"><div>${o.created_at || ''} • ${o.type}</div><div class="mono">${sign} ${fmt(o.amount)}</div></div>`;
    }

    async function init(){
      if(!token){ document.body.innerHTML='<div class="container">Token tidak sah.</div>'; return; }
      const r = await apiGet('portal', { token });
      if(!r.ok || !r.data){ document.body.innerHTML='<div class="container">Portal tidak ditemui.</div>'; return; }
      const d = r.data;
      saleId.textContent = d.sale_id;
      custName.textContent = d.customer_name || 'Pelanggan';
      bal.textContent = fmt(d.balance);
      const capAmt = Math.floor((d.rebate_initial||0) * (d.max_pct||0));
      cap.textContent = fmt(capAmt);

      if(d.rebate_expiry_date){
        const days = countdown(d.rebate_expiry_date);
        expiryBox.innerHTML = `<div class="badge">Tamat: ${d.rebate_expiry_date}</div><div class="badge">Baki hari: ${days}</div>`;
      }else{
        expiryBox.innerHTML = `<div class="badge">Tiada tarikh tamat ditetapkan</div>`;
      }

      ledger.innerHTML = (d.ledger||[]).map(line).join('') || '<div>Tiada transaksi.</div>';

      const ups = (d.listings||[]).slice(0,6).map(x=>{
        const img=(x.image_urls && x.image_urls.split(',')[0])||'';
        return `<div class="card">${img?`<img class="listing-img" src="${img}">`:`<div class="listing-img"></div>`}<div class="card-pad"><div class="kicker">${x.brand}</div><div class="h2" style="font-size:18px">${x.model||''}</div><div class="price">${fmt(x.price||0)}</div></div></div>`;
      }).join('');
      upsell.innerHTML = ups || '<div class="card card-pad">Kemaskini kereta baharu akan dipaparkan di sini.</div>';
    }

    async function createBooking(){
      // Untuk keselamatan (portal pelanggan public), kita minta pelanggan WA untuk sahkan
      bkResult.textContent = 'Terima kasih! Sila WhatsApp kami untuk sahkan slot. (Integrasi terus memerlukan login ejen.)';
    }

    init();
  </script>
</body>
</html>
