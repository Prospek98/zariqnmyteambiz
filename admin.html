<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Admin Panel — CarHub Johor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="./config.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    header{padding:16px 20px;background:#111827;display:flex;justify-content:space-between; align-items:center}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    label{display:block;margin:8px 0 4px}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    .btn{background:#0ea5e9;color:#fff;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;margin-top:10px}
    .muted{color:#9ca3af}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ok{color:#86efac}
    .err{color:#fca5a5}
  </style>
</head>
<body>
<header>
  <div style="font-weight:700" id="brand">CarHub Johor — Admin</div>
  <div id="loginArea"></div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Tambah Ejen</h3>
      <label>Nama</label><input id="s_name">
      <label>E-mel (Google)</label><input id="s_email" placeholder="nama@gmail.com">
      <label>Telefon</label><input id="s_phone">
      <label>WhatsApp</label><input id="s_wa" placeholder="60XXXXXXXXX">
      <label>Lokasi</label>
      <select id="s_loc">
        <option>Johor Bahru</option><option>Skudai</option><option>Pasir Gudang</option>
        <option>Batu Pahat</option><option>Muar</option><option>Kluang</option>
        <option>Pontian</option><option>Kota Tinggi</option><option>Segamat</option>
        <option>Mersing</option><option>Tangkak</option>
      </select>
      <label>Komisen (RM)</label><input id="s_comm" type="number" value="500">
      <button class="btn" onclick="addSeller()">Simpan</button>
      <div id="s_out" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Cipta Jualan + Portal</h3>
      <label>Nama Pelanggan</label><input id="c_name">
      <label>Telefon Pelanggan</label><input id="c_phone">
      <label>Seller ID</label><input id="c_seller">
      <label>Brand</label><input id="c_brand" placeholder="Proton">
      <label>Model</label><input id="c_model" placeholder="X70">
      <label>Variant</label><input id="c_var" placeholder="1.5T Premium">
      <label>OTR Price</label><input id="c_otr" type="number" value="0">
      <label>Rebate Initial (RM)</label><input id="c_rebate" type="number" value="2000">
      <label>Maks Rebate % per claim (contoh 0.25)</label><input id="c_pct" type="number" step="0.01" value="0.25">
      <label>Tarikh Expiry Rebate</label><input id="c_exp" type="date">
      <button class="btn" onclick="createSale()">Cipta</button>
      <div id="c_out" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Rebate Topup / Redeem (Manual)</h3>
      <label>Sale ID</label><input id="r_sale">
      <label>Jumlah (RM)</label><input id="r_amt" type="number" value="100">
      <label>Channel</label>
      <select id="r_channel"><option>service</option><option>insurance</option><option>roadtax</option><option>other</option></select>
      <div class="row">
        <button class="btn" onclick="rebateTopup()">Topup</button>
        <button class="btn" onclick="rebateRedeem()">Redeem</button>
      </div>
      <div id="r_out" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Kemaskini Status Booking</h3>
      <label>Booking ID</label><input id="b_id">
      <label>Status Baru</label>
      <select id="b_status">
        <option>pending</option><option>pickup_scheduled</option><option>picked_up</option>
        <option>at_center</option><option>servicing</option><option>ready</option>
        <option>delivered</option><option>completed</option><option>cancelled</option>
      </select>
      <label>Catatan</label><input id="b_note">
      <button class="btn" onclick="updateBooking()">Simpan</button>
      <div id="b_out" class="muted" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
  document.getElementById('brand').textContent = BRAND_NAME + " — Admin";

  // Google Sign-In
  window.onload = function(){
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: onSignIn
    });
    google.accounts.id.renderButton(
      document.getElementById("loginArea"),
      { theme: "outline", size: "large", text: "signin_with" }
    );
  }
  function onSignIn(res){
    localStorage.setItem("id_token", res.credential);
    document.getElementById("loginArea").innerHTML = '<span class="ok">Signed in ✓</span>';
  }

  async function addSeller(){
    const payload = {
      name: val('s_name'), email: val('s_email'), phone: val('s_phone'),
      whatsapp: val('s_wa'), location: val('s_loc'), commission_value: +val('s_comm')||0
    };
    const r = await apiPost('add_seller', payload, true);
    document.getElementById('s_out').innerHTML = r.ok ? 
      `<span class="ok">OK</span> • Seller ID: <b>${r.data.seller_id}</b> • <a href="${r.data.public_url}">Public</a>` :
      `<span class="err">${r.error||'Gagal'}</span>`;
  }

  async function createSale(){
    const payload = {
      customer_name: val('c_name'), customer_phone: val('c_phone'),
      seller_id: val('c_seller'), brand: val('c_brand'), model: val('c_model'), variant: val('c_var'),
      on_the_road_price: +val('c_otr')||0, rebate_initial: +val('c_rebate')||0,
      rebate_max_pct_per_claim: +val('c_pct')||0.25, rebate_expiry_date: val('c_exp')
    };
    const r = await apiPost('create_sale', payload, true);
    document.getElementById('c_out').innerHTML = r.ok ?
      `<span class="ok">OK</span> • Sale ID: <b>${r.data.sale_id}</b> • <a href="${r.data.portal_url}" target="_blank">Portal Pelanggan</a>` :
      `<span class="err">${r.error||'Gagal'}</span>`;
  }

  async function rebateTopup(){
    const payload = { sale_id: val('r_sale'), amount: +val('r_amt')||0, channel: val('r_channel') };
    const r = await apiPost('rebate_topup', payload, true);
    document.getElementById('r_out').innerHTML = r.ok ? `<span class="ok">OK</span> • Baki: ${fmtRM(r.data.balance)}` : `<span class="err">${r.error}</span>`;
  }
  async function rebateRedeem(){
    const payload = { sale_id: val('r_sale'), amount: +val('r_amt')||0, channel: val('r_channel') };
    const r = await apiPost('rebate_redeem', payload, true);
    document.getElementById('r_out').innerHTML = r.ok ? `<span class="ok">OK</span> • Diguna: ${fmtRM(r.data.used)} • Baki: ${fmtRM(r.data.balance)}` : `<span class="err">${r.error}</span>`;
  }

  async function updateBooking(){
    const payload = { id: val('b_id'), status: val('b_status'), notes: val('b_note') };
    const r = await apiPost('update_booking_status', payload, true);
    document.getElementById('b_out').innerHTML = r.ok ? `<span class="ok">OK</span> • Status: <b>${r.data.status}</b>` : `<span class="err">${r.error}</span>`;
  }

  function val(id){ return document.getElementById(id).value.trim(); }
</script>
</body>
</html>
