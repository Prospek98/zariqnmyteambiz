<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Admin • CarHub Johor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <script src="./config.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header class="container row" style="justify-content:space-between">
    <div class="logo"><span class="logo-dot"></span>Admin • CarHub Johor</div>
    <div id="authBox" class="row"></div>
  </header>

  <main class="container grid grid-2">

    <!-- ====== CMS / Site Settings ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Laman</div>
        <h2 class="h2">Seting Laman (Logo, Hero, WhatsApp)</h2>
        <div class="grid grid-2">
          <input id="cfg_brand" class="input" placeholder="Brand Name">
          <input id="cfg_wa" class="input" placeholder="WhatsApp default (601...)">
          <input id="cfg_hero" class="input" placeholder="Hero Title">
          <textarea id="cfg_points" class="input" placeholder="Bullet points (asingkan dengan ; )"></textarea>
          <input id="logo_file" type="file" class="input" accept=".png,.jpg,.jpeg,.svg">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="saveConfig()">Simpan Seting</button>
          <button class="btn btn-ghost" onclick="uploadLogo()">Upload Logo</button>
        </div>
        <div id="cfgResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== Brands ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Jenama</div>
        <h2 class="h2">Urus Jenama</h2>
        <div class="row">
          <input id="brand_name" class="input" placeholder="Nama jenama (cth Proton)">
          <button class="btn" onclick="addBrand()">Tambah Jenama</button>
        </div>
        <div class="sep"></div>
        <div id="brandList" class="grid grid-2"></div>
      </div>
    </section>

    <!-- ====== Tambah Ejen ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Ejen</div>
        <h2 class="h2">Tambah Ejen Baharu</h2>
        <div class="grid grid-2">
          <input id="s_name" class="input" placeholder="Nama ejen">
          <input id="s_email" class="input" placeholder="Email ejen">
          <input id="s_phone" class="input" placeholder="Telefon">
          <input id="s_wa" class="input" placeholder="WhatsApp (601xxxxxxxx)">
          <input id="s_loc" class="input" placeholder="Lokasi (contoh Johor Bahru)">
          <input id="s_photo" class="input" placeholder="Photo URL (optional)">
          <select id="s_comm_type" class="select"><option>RM</option><option>%</option></select>
          <input id="s_comm_val" class="input" placeholder="Komisen nilai">
        </div>
        <div class="sep"></div>
        <button class="btn" onclick="addSeller()">Simpan</button>
        <div id="sellerResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== Rekod Jualan & Portal ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Jualan</div>
        <h2 class="h2">Rekod Jualan & Jana Portal Pelanggan</h2>
        <div class="grid grid-2">
          <input id="c_name" class="input" placeholder="Nama pelanggan">
          <input id="c_phone" class="input" placeholder="Telefon pelanggan">
          <input id="c_seller" class="input" placeholder="Seller ID (cth S-... )">
          <input id="c_brand" class="input" placeholder="Jenama">
          <input id="c_model" class="input" placeholder="Model">
          <input id="c_variant" class="input" placeholder="Variant">
          <input id="c_otr" class="input" placeholder="On-the-road price">
          <input id="c_rebate" class="input" placeholder="Initial rebate (RM)">
          <input id="c_pct" class="input" placeholder="Max % per claim (cth 0.25)">
          <input id="c_exp" class="input" placeholder="Tarikh tamat (YYYY-MM-DD)">
        </div>
        <div class="sep"></div>
        <button class="btn" onclick="createSale()">Simpan & Jana Portal</button>
        <div id="saleResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== Listings: Tambah & Terbit ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Inventori</div>
        <h2 class="h2">Tambah Listing Kereta</h2>
        <div class="grid grid-2">
          <input id="l_brand" class="input" placeholder="Jenama">
          <input id="l_model" class="input" placeholder="Model">
          <input id="l_variant" class="input" placeholder="Variant">
          <input id="l_price" class="input" placeholder="Harga (RM)">
          <input id="l_images" type="file" class="input" multiple accept=".jpg,.jpeg,.png,.webp">
          <select id="l_status" class="select"><option value="draft">draft</option><option value="active">active</option></select>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="addListing()">Tambah Listing</button>
        </div>
        <div class="sep"></div>
        <div class="grid grid-2">
          <input id="pub_id" class="input" placeholder="Listing ID (L-...)">
          <select id="pub_status" class="select"><option value="active">active</option><option value="draft">draft</option><option value="archived">archived</option></select>
          <button class="btn" onclick="publishListing()">Ubah Status</button>
        </div>
        <div id="listResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== Dashboard Jualan ====== -->
    <section class="card" style="grid-column:1/-1">
      <div class="card-pad">
        <div class="kicker">Dashboard</div>
        <h2 class="h2">Ringkasan Jualan & Rebate</h2>
        <button class="btn" onclick="loadSummary()">Muatkan Ringkasan</button>
        <div class="sep"></div>
        <div id="sumTotals" class="row"></div>
        <div class="sep"></div>
        <div id="sumTable"></div>
      </div>
    </section>

    <!-- ====== Roadtax ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Roadtax/Insurans</div>
        <h2 class="h2">Sebut Harga & Cover Note</h2>
        <div class="grid grid-2">
          <input id="rt_id" class="input" placeholder="Roadtax Request ID (RT-...)">
          <input id="rt_quote" class="input" placeholder="Quote (RM)">
          <button class="btn" onclick="setQuote()">Set Quote</button>
        </div>
        <div class="sep"></div>
        <div class="grid grid-2">
          <input id="rt_id2" class="input" placeholder="Roadtax Request ID (RT-...)">
          <input id="rt_file" type="file" class="input" accept=".pdf,.jpg,.png">
          <button class="btn" onclick="uploadCover()">Upload Cover Note</button>
        </div>
        <div id="rtResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ====== Booking status ====== -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Servis</div>
        <h2 class="h2">Kemaskini Status Booking</h2>
        <div class="grid grid-2">
          <input id="bk_id" class="input" placeholder="Booking ID (BK-...)">
          <select id="bk_status" class="select">
            <option>pending</option><option>confirmed</option><option>picked_up</option>
            <option>in_center</option><option>servicing</option><option>returning</option>
            <option>completed</option><option>cancelled</option>
          </select>
          <input id="bk_notes" class="input" placeholder="Nota (optional)">
          <button class="btn" onclick="updateBooking()">Kemaskini</button>
        </div>
        <div id="bkResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

  </main>

  <footer class="container footer">© <span id="year"></span> CarHub Johor</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Auth UI =====
    window.onload = () => {
      const box = document.getElementById('authBox');
      if(localStorage.getItem('id_token')){
        box.innerHTML = `<span class="badge">Logged in</span><button class="btn btn-ghost" onclick="signOut()">Sign out</button>`;
      } else {
        box.innerHTML = `<div id="g_id_onload" data-client_id="${CLIENT_ID}" data-auto_prompt="false" data-callback="onSignIn"></div>
        <div class="g_id_signin" data-type="standard" data-size="large"></div>`;
        google.accounts.id.initialize({ client_id: CLIENT_ID, callback:onSignIn });
        google.accounts.id.renderButton(document.querySelector('.g_id_signin'), { theme:'outline', size:'large' });
      }
      preloadConfig();
      loadBrands();
    };
    function onSignIn(res){ if(res && res.credential){ localStorage.setItem('id_token', res.credential); location.reload(); } }
    function signOut(){ localStorage.removeItem('id_token'); location.reload(); }

    // ===== CMS =====
    async function preloadConfig(){
      const r = await apiGet('config', {});
      if(!r.ok) return;
      const c=r.data;
      cfg_brand.value = c.brand_name || '';
      cfg_wa.value = c.default_whatsapp || '';
      cfg_hero.value = c.hero_title || '';
      cfg_points.value = (c.hero_points||[]).join(';');
    }
    async function saveConfig(){
      const payload = {
        brand_name: cfg_brand.value,
        default_whatsapp: cfg_wa.value,
        hero_title: cfg_hero.value,
        hero_points: cfg_points.value
      };
      const r = await apiPost('set_config', payload, true);
      cfgResult.textContent = r.ok ? 'Seting disimpan.' : (r.error||'Gagal');
    }
    async function uploadLogo(){
      const f = logo_file.files[0]; if(!f){ alert('Pilih logo'); return; }
      const b64 = await toBase64(f);
      const r = await apiPost('upload_logo', { base64: b64 }, true);
      cfgResult.textContent = r.ok ? 'Logo dikemas kini.' : (r.error||'Gagal');
    }

    // ===== Brands =====
    async function loadBrands(){
      const r = await apiGet('brands', {});
      if(!r.ok) return;
      brandList.innerHTML = (r.data||[]).map(b=>{
        const badge = b.status==='active' ? 'badge' : 'badge btn-ghost';
        const to = b.status==='active' ? 'inactive' : 'active';
        return `<div class="card"><div class="card-pad row" style="justify-content:space-between">
          <div><span class="${badge}">${b.name}</span> <span class="mono">${b.id}</span></div>
          <button class="btn btn-ghost" onclick="toggleBrand('${b.id}','${to}')">${to}</button>
        </div></div>`;
      }).join('');
    }
    async function addBrand(){
      const name = brand_name.value.trim(); if(!name){ alert('Masukkan nama jenama'); return; }
      const r = await apiPost('add_brand', { name }, true);
      if(r.ok){ brand_name.value=''; loadBrands(); } else alert(r.error||'Gagal');
    }
    async function toggleBrand(id, status){
      const r = await apiPost('set_brand_status', { id, status }, true);
      if(r.ok) loadBrands(); else alert(r.error||'Gagal');
    }

    // ===== Sellers =====
    async function addSeller(){
      const payload = {
        name:s_name.value,email:s_email.value,phone:s_phone.value,
        whatsapp:s_wa.value,location:s_loc.value,photo_url:s_photo.value,
        commission_type:s_comm_type.value,commission_value:s_comm_val.value
      };
      const r=await apiPost('add_seller', payload, true);
      sellerResult.textContent = r.ok ? `Ejen ditambah. ID ${r.data.seller_id}
Public URL: ${r.data.public_url}
Portal URL: ${r.data.portal_url}` : (r.error||'Gagal');
    }

    // ===== Sales & Portal =====
    async function createSale(){
      const payload={
        customer_name:c_name.value, customer_phone:c_phone.value,
        seller_id:c_seller.value, brand:c_brand.value, model:c_model.value, variant:c_variant.value,
        on_the_road_price:c_otr.value, rebate_initial:c_rebate.value,
        rebate_max_pct_per_claim:c_pct.value, rebate_expiry_date:c_exp.value
      };
      const r=await apiPost('create_sale', payload, true);
      saleResult.textContent = r.ok ? `Sale ID ${r.data.sale_id} • Portal: ${r.data.portal_url}` : (r.error||'Gagal');
    }

    // ===== Listings =====
    async function addListing(){
      const files = Array.from(l_images.files||[]);
      const imgs = await Promise.all(files.map(toBase64));
      const payload = {
        brand: l_brand.value, model: l_model.value, variant: l_variant.value,
        price: l_price.value, base64_images: imgs, status: l_status.value
      };
      const r=await apiPost('add_listing', payload, true);
      listResult.textContent = r.ok ? `Listing ditambah. ID ${r.data.id}` : (r.error||'Gagal');
    }
    async function publishListing(){
      const r=await apiPost('set_listing_status', { id: pub_id.value, status: pub_status.value }, true);
      listResult.textContent = r.ok ? `Status listing ${r.data.id}: ${r.data.status}` : (r.error||'Gagal');
    }

    // ===== Dashboard =====
    async function loadSummary(){
      const r=await apiPost('sales_summary', {}, true);
      if(!r.ok){ sumTotals.textContent='Gagal muat ringkasan'; return; }
      const t=r.data.totals;
      sumTotals.innerHTML = `
        <div class="badge">Jumlah jualan: ${t.sales}</div>
        <div class="badge">Jumlah OTR: ${fmtRM(t.otr)}</div>
        <div class="badge">Rebate awal diberi: ${fmtRM(t.rebate_initial)}</div>
        <div class="badge">Redeem: ${fmtRM(t.redeem)}</div>
        <div class="badge">Topup/Adjust: ${fmtRM(t.topup_adjust)}</div>
      `;
      const rows = r.data.by_seller||[];
      sumTable.innerHTML = `
        <div class="grid grid-2">
          ${rows.map(x=>`
            <div class="card"><div class="card-pad">
              <div class="h2" style="font-size:18px">Seller: ${x.seller_id}</div>
              <div class="row"><span class="badge">Sales: ${x.sales}</span><span class="badge">OTR: ${fmtRM(x.otr)}</span></div>
              <div class="row"><span class="badge">Rebate Awal: ${fmtRM(x.rebate_initial)}</span><span class="badge">Redeem: ${fmtRM(x.redeem)}</span></div>
              <div class="row"><span class="badge">Topup/Adjust: ${fmtRM(x.topup_adjust)}</span></div>
            </div></div>
          `).join('')}
        </div>`;
    }

    // ===== Roadtax =====
    async function setQuote(){
      const r=await apiPost('set_roadtax_quote', { id:rt_id.value, amount:rt_quote.value }, true);
      rtResult.textContent = r.ok ? `Quote ditetapkan: RM ${r.data.quote_amount}` : (r.error||'Gagal');
    }
    async function uploadCover(){
      const file=rt_file.files[0]; if(!file){ alert('Pilih fail'); return; }
      const b64 = await toBase64(file);
      const r=await apiPost('upload_cover_note', { id:rt_id2.value, base64:b64 }, true);
      rtResult.textContent = r.ok ? `Upload berjaya: ${r.data.cover_note_url}` : (r.error||'Gagal');
    }

    // ===== Booking =====
    async function updateBooking(){
      const r=await apiPost('update_booking_status', { id:bk_id.value, status:bk_status.value, notes:bk_notes.value }, true);
      bkResult.textContent = r.ok ? `Status: ${r.data.status}` : (r.error||'Gagal');
    }

    function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  </script>
</body>
</html>
