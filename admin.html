<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <title>Admin • CarHub Johor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <script defer src="./config.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header class="container row" style="justify-content:space-between">
    <div class="logo"><span class="logo-dot"></span>Admin • CarHub Johor</div>
    <div id="authBox" class="row"></div>
  </header>

  <main class="container grid grid-2">
    <!-- Tambah Ejen -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Ejen</div>
        <h2 class="h2">Tambah Ejen Baharu</h2>
        <div class="grid grid-2">
          <input id="s_name" class="input" placeholder="Nama ejen">
          <input id="s_email" class="input" placeholder="Email ejen">
          <input id="s_phone" class="input" placeholder="Telefon">
          <input id="s_wa" class="input" placeholder="WhatsApp (601xxxxxxxx)">
          <input id="s_loc" class="input" placeholder="Lokasi (contoh Johor Bahru)">
          <input id="s_photo" class="input" placeholder="Photo URL (optional)">
          <select id="s_comm_type" class="select"><option>RM</option><option>%</option></select>
          <input id="s_comm_val" class="input" placeholder="Komisen nilai">
        </div>
        <div class="sep"></div>
        <button class="btn" onclick="addSeller()">Simpan</button>
        <div id="sellerResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Create Sale + Portal -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Jualan</div>
        <h2 class="h2">Rekod Jualan & Jana Portal Pelanggan</h2>
        <div class="grid grid-2">
          <input id="c_name" class="input" placeholder="Nama pelanggan">
          <input id="c_phone" class="input" placeholder="Telefon pelanggan">
          <input id="c_seller" class="input" placeholder="Seller ID (cth S-... )">
          <input id="c_brand" class="input" placeholder="Jenama">
          <input id="c_model" class="input" placeholder="Model">
          <input id="c_variant" class="input" placeholder="Variant">
          <input id="c_otr" class="input" placeholder="On-the-road price">
          <input id="c_rebate" class="input" placeholder="Initial rebate (RM)">
          <input id="c_pct" class="input" placeholder="Max % per claim (cth 0.25)">
          <input id="c_exp" class="input" placeholder="Tarikh tamat (YYYY-MM-DD)">
        </div>
        <div class="sep"></div>
        <button class="btn" onclick="createSale()">Simpan & Jana Portal</button>
        <div id="saleResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Topup / Redeem manual -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Rebate</div>
        <h2 class="h2">Topup / Redeem Manual</h2>
        <div class="grid grid-2">
          <input id="r_sale" class="input" placeholder="Sale ID (SL-...)">
          <input id="r_phone" class="input" placeholder="Telefon pelanggan">
          <input id="r_amt" class="input" placeholder="Amaun (RM)">
          <input id="r_note" class="input" placeholder="Nota">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="rebateTopup()">Topup</button>
          <button class="btn btn-ghost" onclick="rebateRedeem()">Redeem</button>
        </div>
        <div id="rebateResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Roadtax -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Roadtax/Insurans</div>
        <h2 class="h2">Kira Sebut Harga & Upload Cover Note</h2>
        <div class="grid grid-2">
          <input id="rt_id" class="input" placeholder="Roadtax Request ID (RT-...)">
          <input id="rt_quote" class="input" placeholder="Quote (RM)">
          <button class="btn" onclick="setQuote()">Set Quote</button>
        </div>
        <div class="sep"></div>
        <div class="grid grid-2">
          <input id="rt_id2" class="input" placeholder="Roadtax Request ID (RT-...)">
          <input id="rt_file" type="file" class="input" accept=".pdf,.jpg,.png">
          <button class="btn" onclick="uploadCover()">Upload Cover Note</button>
        </div>
        <div id="rtResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Booking status -->
    <section class="card">
      <div class="card-pad">
        <div class="kicker">Servis</div>
        <h2 class="h2">Kemaskini Status Booking</h2>
        <div class="grid grid-2">
          <input id="bk_id" class="input" placeholder="Booking ID (BK-...)">
          <select id="bk_status" class="select">
            <option>pending</option>
            <option>confirmed</option>
            <option>picked_up</option>
            <option>in_center</option>
            <option>servicing</option>
            <option>returning</option>
            <option>completed</option>
            <option>cancelled</option>
          </select>
          <input id="bk_notes" class="input" placeholder="Nota (optional)">
          <button class="btn" onclick="updateBooking()">Kemaskini</button>
        </div>
        <div id="bkResult" class="notice" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <footer class="container footer">© <span id="year"></span> CarHub Johor</footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Google Sign-In
    window.onload = () => {
      const box = document.getElementById('authBox');
      if(localStorage.getItem('id_token')){
        box.innerHTML = `<span class="badge">Logged in</span><button class="btn btn-ghost" onclick="signOut()">Sign out</button>`;
      } else {
        box.innerHTML = `<div id="g_id_onload" data-client_id="${CLIENT_ID}" data-auto_prompt="false" data-callback="onSignIn"></div>
        <div class="g_id_signin" data-type="standard" data-size="large"></div>`;
        google.accounts.id.initialize({ client_id: CLIENT_ID, callback:onSignIn });
        google.accounts.id.renderButton(document.querySelector('.g_id_signin'), { theme:'outline', size:'large' });
      }
    };
    function onSignIn(res){
      if(res && res.credential){
        localStorage.setItem('id_token', res.credential);
        location.reload();
      }
    }
    function signOut(){ localStorage.removeItem('id_token'); location.reload(); }

    // Admin actions
    async function addSeller(){
      const payload = {
        name:s_name.value,email:s_email.value,phone:s_phone.value,
        whatsapp:s_wa.value,location:s_loc.value,photo_url:s_photo.value,
        commission_type:s_comm_type.value,commission_value:s_comm_val.value
      };
      const r=await apiPost('add_seller', payload, true);
      sellerResult.textContent = r.ok ? `Ejen ditambah. ID ${r.data.seller_id}
Public URL: ${r.data.public_url}
Portal URL: ${r.data.portal_url}` : (r.error||'Gagal');
    }
    async function createSale(){
      const payload={
        customer_name:c_name.value, customer_phone:c_phone.value,
        seller_id:c_seller.value, brand:c_brand.value, model:c_model.value, variant:c_variant.value,
        on_the_road_price:c_otr.value, rebate_initial:c_rebate.value,
        rebate_max_pct_per_claim:c_pct.value, rebate_expiry_date:c_exp.value
      };
      const r=await apiPost('create_sale', payload, true);
      saleResult.textContent = r.ok ? `Sale ID ${r.data.sale_id} • Portal: ${r.data.portal_url}` : (r.error||'Gagal');
    }
    async function rebateTopup(){
      const payload={ sale_id:r_sale.value, customer_phone:r_phone.value, amount:r_amt.value, channel:'other', note:r_note.value };
      const r=await apiPost('rebate_topup', payload, true);
      rebateResult.textContent = r.ok ? `Baki terkini: RM ${r.data.balance}` : (r.error||'Gagal');
    }
    async function rebateRedeem(){
      const payload={ sale_id:r_sale.value, amount:r_amt.value, channel:'service', note:r_note.value };
      const r=await apiPost('rebate_redeem', payload, true);
      rebateResult.textContent = r.ok ? `Digunakan: RM ${r.data.used} • Baki: RM ${r.data.balance}` : (r.error||'Gagal');
    }
    async function setQuote(){
      const r=await apiPost('set_roadtax_quote', { id:rt_id.value, amount:rt_quote.value }, true);
      rtResult.textContent = r.ok ? `Quote ditetapkan: RM ${r.data.quote_amount}` : (r.error||'Gagal');
    }
    async function uploadCover(){
      const file=rt_file.files[0]; if(!file){ alert('Pilih fail'); return; }
      const b64 = await toBase64(file);
      const r=await apiPost('upload_cover_note', { id:rt_id2.value, base64:b64 }, true);
      rtResult.textContent = r.ok ? `Upload berjaya: ${r.data.cover_note_url}` : (r.error||'Gagal');
    }
    async function updateBooking(){
      const r=await apiPost('update_booking_status', { id:bk_id.value, status:bk_status.value, notes:bk_notes.value }, true);
      bkResult.textContent = r.ok ? `Status: ${r.data.status}` : (r.error||'Gagal');
    }
    function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  </script>
</body>
</html>
